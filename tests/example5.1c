
&насервере
процедура обработкасообщениясистемывзаимодействия(сообщение, дополнительныепараметры)

    теловалюты = нрег(сообщение.текст);// получаем весь текст сообщения
    если ((стрнайти(теловалюты, "usd") <> 0) или (стрнайти(теловалюты, "доллар") <> 0)) тогда
        кодвалюты = "840";
    иначеесли ((стрнайти(теловалюты, "eur") <> 0) или (стрнайти(теловалюты, "евро") <> 0)) тогда
        кодвалюты = "978";
    иначеесли ((стрнайти(теловалюты, "byn") <> 0) или (стрнайти(теловалюты, "белорусский рубль") <> 0)) тогда
        кодвалюты = "933";
    иначе
        кодвалюты = "0";
    конецесли;

    // выводим наш ответ на экран пользователю (в зависимости от кода валюты - покажем ее курс)
    нашответ = системавзаимодействия.создатьсообщение(сообщение.обсуждение);
    если (кодвалюты <> "0") тогда
        // параметры: адрес, порт (http:80, https:443), пользователь, пароль, прокси, таймаут в секундах, защищ.соединение (для https)
        соединение = новый httpсоединение("cbrates.rbc.ru");
        // получение текста страницы через запрос.
        httpзапрос = новый httpзапрос(("tsv/" + (кодвалюты + (формат(текущаядата(), "/yyyy/mm/dd") + ".tsv"))));
        ответ = соединение.получить(httpзапрос);// get запрос

        если (ответ.кодсостояния <> 200) тогда
            нашответ.текст = ("код ошибки" + ответ.кодсостояния);
        иначе
            содержимое = ответ.получитьтелокакстроку();

            стрответа = "курс валюты";
            если (кодвалюты = "840") тогда
                стрответа = (стрответа + "доллара: ");
            иначеесли (кодвалюты = "978") тогда
                стрответа = (стрответа + "евро: ");
            иначеесли (кодвалюты = "933") тогда
                стрответа = (стрответа + "белорусского рубля: ");
            конецесли;

            мн = стрразделитель(содержимое, символы.таб);
            курсвалюты = (_число(мн[1]) / _число(мн[0]));
            стрответа = (стрответа + курсвалюты);
            нашответ.текст = стрответа;
        конецесли;
    иначе
        нашответ.текст = "не найдена валюта";
    конецесли;

    нашответ.записать();// сохранение в системе взаимодействия

конецпроцедуры
